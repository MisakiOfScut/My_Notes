

# Linux 进程和线程

## 进程描述符

内核把进程的列表存放在称为**任务队列**的双向循环链表中，链表的每一项都是类型为**task_struct**，称为进程描述符的结构

内核通过唯一的进程标识值**PID**来标识每个进程。

每个task_struct都包含一个指向其父进程task_struct、称为**parent的指针**，还包含一个称为**children的子进程链表**



## 进程创建

通过fork拷贝当前进程创建一个子进程，再用exec函数读取可执行文件并将其载入地址空间运行；

### 写时拷贝

fork的实际开销是创建唯一的task_struct和复制父进程的页表（这意味着父子进程共享页面），当父/子进程修改页面时数据才会被复制

### vfork ()

除了**不拷贝父进程页表**，其他功能与fork()相同，子进程**作为父进程一个单独的线程在其地址空间运行**；**父进程被阻塞，直到子进程退出或执行exec**；



## Linux的线程

Linux把所有的线程都当作进程来实现，线程仅仅被视为一个与其他进程共享某些资源的进程。每个线程拥有属于自己的task_struct。

### clone()

fork(), vfork()和 __clone()库函数都根据各自需要的参数标志去调用clone，然后由clone调用do_fork()；

**所以本质上进程、线程都是调用clone创建的，只不过传递的参数决定了父子进程是否共享文件系统资源、地址空间、文件描述符、信号处理函数，如果共享那么子进程就是一个所谓的线程。**像一般的fork，就只传递共享信号处理函数的SIGHAND参数。

### 内核线程

独立运行在内核的标准进程。内核线程和普通进程的区别是它们没有独立的地址空间。



## 进程终结

当一个进程终结时，内核必须释放其占有的资源并通知父进程。

大概：输出记账，递减进程占用的mm_struct、文件描述符、文件系统数据等的引用计数，保存exit退出代码到task_struct，**向父进程发送信号，给子进程重新找养父，把进程状态设置为EXIT_ZOMBIE**（处于该状态的进程不会再被调度）

### 删除进程描述符

在父进程获得已终结的子进程信息后，或者通知内核它不需要信息后，子进程的task_struct才被释放

### 僵尸进程

根据前文，如果父进程在子进程之前退出，那必须为子进程找一个新的父亲，否则后面子进程退出后永远会处于僵尸状态，它的task_struct浪费内存（没有父进程来通知释放这些信息）

解决方法是在子进程当前的线程组内找一个作为它们的父亲，如果不行就让init做它们的父亲

https://www.cnblogs.com/Anker/p/3271773.html



## Linux进程调度

CFS完全公平调度：https://www.cnblogs.com/tianguiyu/articles/6091378.html；**公平选择进程，又能保证高优先级进程获得较多的运行时间**



## Linux4种锁机制

### 1. 互斥锁

mutex，用于保证在任何时刻，都只能有一个线程访问该对象。当获取锁操作失败时，线程会进入睡眠，等待锁释放时被唤醒

### 2. 读写锁

rwlock，分为读锁和写锁。处于读操作时，可以允许多个线程同时获得读操作。但是同一时刻只能有一个线程可以获得写锁。其它获取写锁失败的线程都会进入睡眠状态，直到写锁释放时被唤醒。 注意：写锁会阻塞其它读写锁。当有一个线程获得写锁在写时，读锁也不能被其它线程获取；写者优先于读者（一旦有写者，则后续读者必须等待，唤醒时优先考虑写者）。适用于读取数据的频率远远大于写数据的频率的场合。

### 3. 自旋锁

spinlock，在任何时刻同样只能有一个线程访问对象。但是当获取锁操作失败时，不会进入睡眠，而是会在原地自旋，直到锁被释放。这样节省了线程从睡眠状态到被唤醒期间的消耗，在加锁时间短暂的环境下会极大的提高效率。但如果加锁时间过长，则会非常浪费CPU资源。https://www.cnblogs.com/kuliuheng/p/4064680.html

### 4. RCU

即read-copy-update，在修改数据时，首先需要读取数据，然后生成一个副本，对副本进行修改。修改完成后，再将老数据update成新的数据。使用RCU时，读者几乎不需要同步开销，既不需要获得锁，也不使用原子指令，不会导致锁竞争，因此就不用考虑死锁问题了。而对于写者的同步开销较大，它需要复制被修改的数据，还必须使用锁机制同步并行其它写者的修改操作。在有大量读操作，少量写操作的情况下效率非常高。https://zhuanlan.zhihu.com/p/89439043